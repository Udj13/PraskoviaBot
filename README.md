# PraskoviaBot

## Описание бота Прасковья 

Простой бот на Python для Телеграм, обертка над Locarus Simple JSON API.
Позволяет видеть основные параметры подключенных спутниковых трекеров поддерживаемых сервером Локарус.
Разработчик сервера для которого предназначен бот: https://locarus.ru/
Пример трекеров которые поддерживаются: https://glonass13.ru/products/category/glonass

Бот позволяет получать координаты трекера, показывает его на карте, показывает технические статусы устройств, а так же считает итог по выбранному клиенту - сколько машин у него ездило в течении месяца.

## Установка

Далее описание установки с нуля на сервер для тех, кто вообще никогда ничего подобного не запускал на Ubuntu.

### Получение токена

Для начала открываем Telegram и пишем боту @BotFather команду /newbot. В ответ он попросит ввести имя и даст длинный токен (ключ) бота.

### Устанавливаем Python 3 или убеждаемся что он есть.
sudo apt install python3

### Устанавливаем менеджер пакетов Pip
sudo apt install pip3

### Создаем виртуальное окружение
Идем туда где будет папка с виртуальными окружениями (грубо говоря место где будут жить наши программы Питона) и создаем там каталог. 
Например, пусть это будет в корне: myvenv.

Делаем виртуальное окружение командой:

python3 -m venv /myvenv/praskovia

Кидаем в этот каталог файлики бота.

### Создаём конфигурационный файт conf.py (его нет в репозитории)
Содержимое это файла:
```python
vk_api = 'апи токен бота который выдает @BotFather'
main_user = 'Основная учетка сервера Локарус'
main_pwd = 'пароль основной учетки'
urlGetPosition = 'http://сервер:8091/do.locator?f=now&m=full&imei='
urlGetDuration = 'http://сервер:8091/do.calc.vars?imei='
urlGetUser = 'http://сервер:8091/do.get.current.user'
urlGetInfo = 'http://сервер:8091/do.get.devices?imei='
users = [000, 111, 222]
``` 

Исправляем всё кроме последней строки (переменной users).
Последняя строка это идентификаторы пользователей которые выдаст команда Прасковьи /userinfo. 
Идентификаторы прописываем для того, чтобы Прасковья общалась только со своими сотрудниками. 
Пока оставляем как есть.

### Ставим модуль для Python
Заходим в папку с виртуальным окружением: 

cd /myvenv/praskovia/

Активируем это окружение: 

. bin/activate

Ставим модуль для работы с Телеграм: 

pip3 install pyTelegramBotAPI

### Тестовый запуск
Теперь можно сделать файл запускаемым:

chmod +x main.py

и попробовать вручную запустить бота командой: 

. main.py

Ищем бота в телеграмме по имени и пишем ему. Если всё нормально, то он запустится и будет реагировать на команду /userinfo. Это как раз те самые айдишники которые надо будет прописать в последнюю строчку конфига в массив users, чтобы он разговаривал только с этими людьми.

Выключаем бота "ctrl-x" и деактивируем виртуальное окружение командой: 

deactivate

Теперь делаем чтобы он запускался автоматически. 

### Запуск как демон (сервис)

В каталоге /etc/systemd/system/ нужно создать файлик, например praskovia_bot.service
В него прописываем:

```ini
[Unit]
Description=PraskoviaBot_Telegram
After=multi-user.target

[Service]
Type=idle
ExecStart=/myvenv/praskovia/bin/python /myvenv/praskovia/main.py
Restart=always

[Install]
WantedBy=multi-user.target
```

А дальше всё как с сервером Локаруса. Обновляем список сервисов: 

systemctl daemon_reload 

и запускаем

systemctl start praskovia_bot.service

Всё, квест завершен.


## Команды.
Все команды Прасковья подскажет сама на команду /help


